import React, { createContext, useContext, useEffect, useState, useCallback } from 'react';
import { simpleDriveService } from '../services/simpleDrive';
import { userSettingsService } from '../services/userSettingsService';
import { languageService } from '../services/languageService';
import type { UserData, AccountingData } from '../services/simpleDrive';
import type { UserSettings } from '../services/userSettingsService';

interface SimpleAuthContextType {
    isAuthenticated: boolean;
    user: UserData | null;
    loading: boolean;
    login: () => Promise<void>;
    loginAsGuest: () => Promise<void>;
    logout: () => Promise<void>;
    error: string | null;
    accountingData: AccountingData | null;
    saveData: (data: AccountingData) => Promise<void>;
    syncData: () => Promise<void>;
    // New Dashboard Data
    // New Dashboard Data
    totalAssets: number;
    refreshData: () => Promise<void>;
    // Settings
    settings: UserSettings | null;
    updateSettings: (settings: UserSettings) => Promise<void>;
}

const SimpleAuthContext = createContext<SimpleAuthContextType | undefined>(undefined);

export const SimpleAuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [user, setUser] = useState<UserData | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [accountingData, setAccountingData] = useState<AccountingData | null>(null);
    const [totalAssets, setTotalAssets] = useState(0);
    const [settings, setSettings] = useState<UserSettings | null>(null);

    const refreshData = async () => {
        try {
            console.log('ğŸ”„ é–‹å§‹åˆ·æ–°æ•¸æ“š...');
            
            // é¦–å…ˆåŒæ­¥æœ€æ–°çš„å€å¡Šæ•¸æ“š
            await simpleDriveService.syncLatestBlock();
            console.log('âœ… å€å¡Šæ•¸æ“šåŒæ­¥å®Œæˆ');
            
            // Fetch new snapshot from blockchain service
            const snapshot = simpleDriveService.getCurrentSnapshot();
            
            // èª¿è©¦ï¼šæ‰“å°å¿«ç…§æ•¸æ“š
            console.log('ğŸ” Debug - Current Snapshot:', JSON.stringify(snapshot, null, 2));
            console.log('ğŸ” Debug - Total Assets:', JSON.stringify(snapshot.totalAssets, null, 2));
        
        // Calculate total assets from all currencies
        const totalAssets = snapshot.totalAssets || {};
        const rates: Record<string, number> = {
            'TWD': 1,
            'USD': 30,
            'JPY': 0.22,
            'KRW': 0.025,
            'EUR': 33,
            'USDT': 30,
            'USDC': 30
        };
        
        let totalValue = 0;
        Object.entries(totalAssets).forEach(([currency, amount]) => {
            const rate = rates[currency] || 1;
            totalValue += amount * rate;
            console.log(`ğŸ” Debug - Currency: ${currency}, Amount: ${amount}, Rate: ${rate}, Value: ${amount * rate}`);
        });
        
        console.log('ğŸ” Debug - Final Total Value:', totalValue);
        console.log('ğŸ” Debug - Total Assets Keys Count:', Object.keys(totalAssets).length);
        
        // å¦‚æœæ²’æœ‰äº¤æ˜“è¨˜éŒ„ä½†æ•¸å€¼ä¸ç‚º0ï¼Œå¼·åˆ¶é‡ç½®ç‚º0
        if (Object.keys(totalAssets).length === 0 && totalValue !== 0) {
            console.log('âš ï¸ å¼·åˆ¶é‡ç½®ç¸½è³‡ç”¢ç‚º 0ï¼ˆæ²’æœ‰äº¤æ˜“è¨˜éŒ„ï¼‰');
            totalValue = 0;
        }
        
        setTotalAssets(totalValue);
        } catch (error) {
            console.error('âŒ åˆ·æ–°æ•¸æ“šå¤±æ•—:', error);
        }
    };

    useEffect(() => {
        const init = async () => {
            try {
                await simpleDriveService.initialize();

                // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥
                if (simpleDriveService.isSignedIn()) {
                    const userData = simpleDriveService.getUser();
                    if (userData) {
                        setUser(userData);
                        setIsAuthenticated(true);
                        await simpleDriveService.syncLatestBlock(); // Ensure blockchain state is synced
                        await loadAccountingData();
                        await loadSettings();
                        await refreshData(); // Load snapshot
                    }
                }
            } catch (err: any) {
                console.error("åˆå§‹åŒ–å¤±æ•—", err);
                setError(err.message || "åˆå§‹åŒ–å¤±æ•—");
            } finally {
                setLoading(false);
            }
        };

        init();
    }, []);

    const loadAccountingData = async () => {
        try {
            const data = await simpleDriveService.readAccountingData();
            setAccountingData(data);
        } catch (err: any) {
            console.error("è¼‰å…¥è³‡æ–™å¤±æ•—", err);
            // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œè³‡æ–™æª”æ¡ˆå¯èƒ½ä¸å­˜åœ¨ï¼Œé€™æ˜¯æ­£å¸¸çš„
            if (!err.message.includes('è³‡æ–™æª”æ¡ˆæœªåˆå§‹åŒ–')) {
                setError(err.message || "è¼‰å…¥è³‡æ–™å¤±æ•—");
            }
        }
    };

    const loadSettings = async () => {
        try {
            console.log('ğŸ“‹ è¼‰å…¥ç”¨æˆ¶è¨­å®šåˆ° Context...');
            const s = await userSettingsService.getSettings();
            if (s) {
                setSettings(s);
                console.log('âœ… è¨­å®šå·²è¼‰å…¥åˆ° Context:', s);
            } else {
                console.warn('âš ï¸ æ²’æœ‰æ‰¾åˆ°ç”¨æˆ¶è¨­å®š');
            }
        } catch (e: any) {
            console.warn("âŒ è¼‰å…¥è¨­å®šå¤±æ•—:", e);
        }
    };

    const login = async () => {
        try {
            setError(null);
            setLoading(true);

            const userData = await simpleDriveService.signIn();
            setUser(userData);
            setIsAuthenticated(true);

            // å®Œæ•´çš„ Google Drive è¨­å®šåˆå§‹åŒ–æµç¨‹
            console.log('ğŸ”§ é–‹å§‹å®Œæ•´çš„ Google Drive è¨­å®šåˆå§‹åŒ–...');
            await initializeGoogleDriveSettings(userData.id);

            // ç™»å…¥æˆåŠŸå¾Œè¼‰å…¥è³‡æ–™
            await loadAccountingData();
            await refreshData();
        } catch (err: any) {
            console.error("ç™»å…¥å¤±æ•—", err);
            setError(err.message || "ç™»å…¥å¤±æ•—");
        } finally {
            setLoading(false);
        }
    };

    // å®Œæ•´çš„ Google Drive è¨­å®šåˆå§‹åŒ–æµç¨‹
    const initializeGoogleDriveSettings = async (userId: string) => {
        console.log('ğŸš€ é–‹å§‹ Google Drive è¨­å®šåˆå§‹åŒ–æµç¨‹...');
        
        try {
            // 1. æª¢æŸ¥ Google Drive ä¸­æ˜¯å¦æœ‰ QuickBook Data è³‡æ–™å¤¾
            console.log('ğŸ“ æª¢æŸ¥ QuickBook Data è³‡æ–™å¤¾...');
            const folderResponse = await gapi.client.drive.files.list({
                q: "name='QuickBook Data' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                fields: 'files(id, name)'
            });
            
            let folderId: string;
            let hasUserSetting = false;
            
            if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                // è³‡æ–™å¤¾å­˜åœ¨
                folderId = folderResponse.result.files[0].id!;
                console.log('âœ… QuickBook Data è³‡æ–™å¤¾å·²å­˜åœ¨:', folderId);
                
                // 2. æª¢æŸ¥è³‡æ–™å¤¾ä¸­æ˜¯å¦æœ‰ user_setting.json
                console.log('ğŸ“„ æª¢æŸ¥ user_setting.json...');
                const fileResponse = await gapi.client.drive.files.list({
                    q: `name='user_setting.json' and '${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, modifiedTime)'
                });
                
                if (fileResponse.result.files && fileResponse.result.files.length > 0) {
                    hasUserSetting = true;
                    console.log('âœ… user_setting.json å·²å­˜åœ¨');
                    
                    // 3. è¼‰å…¥ç¾æœ‰çš„ user_setting.json
                    console.log('ğŸ“¥ è¼‰å…¥ç¾æœ‰çš„ user_setting.json...');
                    const fileId = fileResponse.result.files[0].id!;
                    const downloadResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    
                    const existingSettings = downloadResponse.result as UserSettings;
                    console.log('âœ… æˆåŠŸè¼‰å…¥ç¾æœ‰è¨­å®š:', existingSettings);
                    
                    // 4. ä½¿ç”¨ userSettingsService è¨­å®šè¼‰å…¥çš„è¨­å®š (ä¸è‡ªå‹•ä¿å­˜ï¼Œå› ç‚ºå·²ç¶“å¾ Drive è¼‰å…¥)
                    await userSettingsService.setSettings(existingSettings, false);
                    setSettings(existingSettings);
                    
                } else {
                    console.log('ğŸ“„ user_setting.json ä¸å­˜åœ¨ï¼Œå°‡ä½¿ç”¨ init_setting.json');
                }
            } else {
                // è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œéœ€è¦å‰µå»º
                console.log('ğŸ“ QuickBook Data è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸­...');
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: 'QuickBook Data',
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });
                folderId = createResponse.result.id!;
                console.log('âœ… QuickBook Data è³‡æ–™å¤¾å‰µå»ºæˆåŠŸ:', folderId);
            }
            
            // 5. å¦‚æœæ²’æœ‰ user_setting.jsonï¼Œä½¿ç”¨ init_setting.json
            if (!hasUserSetting) {
                console.log('ğŸ¨ ä½¿ç”¨ init_setting.json å‰µæ–°æ–°è¨­å®š...');
                
                // ä½¿ç”¨ userSettingsService çš„ initialize æ–¹æ³•ï¼Œå®ƒæœƒè‡ªå‹•ä½¿ç”¨ init_setting.json ä½†ä¸è‡ªå‹•ä¿å­˜
                const newSettings = await userSettingsService.initialize(userId, false);
                console.log('âœ… æ–°è¨­å®šå‰µå»ºæˆåŠŸ:', newSettings);
                setSettings(newSettings);
                
                // æ‰‹å‹•ä¿å­˜ä¸€æ¬¡
                console.log('ğŸ’¾ æ‰‹å‹•ä¿å­˜æ–°ç”¨æˆ¶è¨­å®šåˆ° Google Drive...');
                await userSettingsService.saveToDrive();
            }
            
            // 6. ç¢ºä¿è¨­å®šå·²ä¿å­˜åˆ° Google Drive
            //console.log('ğŸ’¾ ç¢ºä¿è¨­å®šå·²ä¿å­˜åˆ° Google Drive...');
            //await userSettingsService.saveToDrive();
            
            console.log('ğŸ‰ Google Drive è¨­å®šåˆå§‹åŒ–å®Œæˆï¼');
            
        } catch (error) {
            console.error('âŒ Google Drive è¨­å®šåˆå§‹åŒ–å¤±æ•—:', error);
            // å¦‚æœå¤±æ•—ï¼Œè‡³å°‘ç¢ºä¿æœ‰åŸºæœ¬è¨­å®š
            try {
                const fallbackSettings = await userSettingsService.initialize(userId);
                setSettings(fallbackSettings);
            } catch (fallbackError) {
                console.error('âŒ å¾Œå‚™è¨­å®šåˆå§‹åŒ–ä¹Ÿå¤±æ•—:', fallbackError);
            }
        }
    };

    const loginAsGuest = async () => {
        try {
            setError(null);
            setLoading(true);
            const userData = await simpleDriveService.loginAsGuest();
            setUser(userData);
            setIsAuthenticated(true);

            // åˆå§‹åŒ–è¨ªå®¢è¨­å®š
            console.log('ğŸ”§ åˆå§‹åŒ–è¨ªå®¢è¨­å®š...');
            await userSettingsService.initialize('guest_user');

            await loadAccountingData();
            // æ³¨æ„ï¼šä¸å†éœ€è¦èª¿ç”¨ loadSettings()ï¼Œå› ç‚º userSettingsService å·²ç¶“è™•ç†äº†
            await refreshData();
        } catch (err: any) {
            console.error("è¨ªå®¢ç™»å…¥å¤±æ•—", err);
            setError("ç„¡æ³•å•Ÿå‹•è¨ªå®¢æ¨¡å¼");
        } finally {
            setLoading(false);
        }
    };

    const logout = async () => {
        try {
            await simpleDriveService.signOut();
            setUser(null);
            setIsAuthenticated(false);
            setAccountingData(null);
            setSettings(null);
            setError(null);
            
            // é‡ç½®èªè¨€æœå‹™
            languageService.reset();
        } catch (e: any) {
            setError(e.message);
        }
    };

    const saveData = async (data: AccountingData) => {
        try {
            await simpleDriveService.saveData(data);
            setAccountingData(data);
        } catch (err: any) {
            console.error("å„²å­˜è³‡æ–™å¤±æ•—", err);
            setError(err.message || "å„²å­˜è³‡æ–™å¤±æ•—");
            throw err;
        }
    };

    const syncData = async () => {
        try {
            const data = await simpleDriveService.syncData();
            setAccountingData(data);
            await refreshData();
        } catch (err: any) {
            console.error("åŒæ­¥è³‡æ–™å¤±æ•—", err);
            setError(err.message || "åŒæ­¥è³‡æ–™å¤±æ•—");
            throw err;
        }
    };

    const updateSettings = async (newSettings: UserSettings) => {
        try {
            console.log('ğŸ’¾ æ›´æ–°è¨­å®šåˆ° Google Drive...');
            
            // ç«‹å³æ›´æ–° Context ä¸­çš„è¨­å®š
            setSettings(newSettings);
            
            // ç•°æ­¥ä¿å­˜ï¼Œä¸é˜»å¡ UI
            Promise.resolve().then(async () => {
                await userSettingsService.setSettings(newSettings);
                console.log('âœ… è¨­å®šæ›´æ–°æˆåŠŸ');
            }).catch(error => {
                console.error('âŒ æ›´æ–°è¨­å®šå¤±æ•—:', error);
                setError(error.message || "æ›´æ–°è¨­å®šå¤±æ•—");
            });
            
        } catch (err: any) {
            console.error('âŒ æ›´æ–°è¨­å®šå¤±æ•—:', err);
            setError(err.message || "æ›´æ–°è¨­å®šå¤±æ•—");
        }
    };

    return (
        <SimpleAuthContext.Provider value={{
            isAuthenticated,
            user,
            loading,
            login,
            loginAsGuest,
            logout,
            error,
            accountingData,
            saveData,
            syncData,
            totalAssets,
            refreshData,
            settings,
            updateSettings
        }}>
            {children}
        </SimpleAuthContext.Provider>
    );
}

export const useSimpleAuth = () => {
    const context = useContext(SimpleAuthContext);
    if (context === undefined) {
        throw new Error('useSimpleAuth must be used within a SimpleAuthProvider');
    }
    return context;
};
